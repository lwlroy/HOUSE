name: Daily House Crawler

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 9:00 åŸ·è¡Œ (UTC+8, æ‰€ä»¥ UTC æ™‚é–“æ˜¯ 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  crawl-houses:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Download previous day data
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: daily-crawler.yml
        name: house-data
        path: ./previous_data/
        if_no_artifact_found: ignore  # ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚æ²’æœ‰å‰ä¸€å¤©çš„è³‡æ–™
      continue-on-error: true
    
    - name: List previous data (for debugging)
      run: |
        echo "ğŸ” æª¢æŸ¥å‰ä¸€å¤©è³‡æ–™ä¸‹è¼‰çµæœï¼š"
        if [ -d "./previous_data" ]; then
          echo "âœ… Previous data directory found:"
          ls -la ./previous_data/
          echo "ğŸ“„ æª”æ¡ˆè©³ç´°è³‡è¨Šï¼š"
          find ./previous_data -name "*.json" -exec echo "ğŸ“‹ {}" \; -exec wc -l {} \;
        else
          echo "âš ï¸ No previous data directory (first run or download failed)"
        fi
    
    - name: Run crawler
      env:
        NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
      run: |
        python simple_luzhou_crawler.py --district all
    
    - name: List current data (for debugging)
      run: |
        if [ -d "./data" ]; then
          echo "ğŸ“ Current data generated:"
          ls -la ./data/
        fi
    
    - name: Upload current data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: house-data
        path: ./data/
        retention-days: 3  # ä¿ç•™ 3 å¤©çš„è³‡æ–™ï¼Œè¶³å¤ åšå‰ä¸€å¤©æ¯”è¼ƒ
    
    - name: Show execution summary
      run: |
        echo "ğŸ‰ House crawler execution completed!"
        echo "ğŸ“Š Check Notion for updated house listings"
        if [ -d "logs" ]; then
          echo "ğŸ“ Logs available in logs/ directory"
        fi
